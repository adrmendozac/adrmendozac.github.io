<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Agregar Fechas â€” Brinteva Worlds</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,300;0,400;0,500;0,600;1,400&family=DM+Serif+Display&display=swap" rel="stylesheet"/>

<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg:      #F4F2EE;
  --white:   #FFFFFF;
  --border:  #E2DDD6;
  --text:    #1A1714;
  --muted:   #706860;
  --accent:  #CA1044;
  --green:   #15803D;
  --radius:  12px;
}

body {
  font-family: 'DM Sans', sans-serif;
  background: #;
  color: var(--text);
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  -webkit-font-smoothing: antialiased;
}

/* â”€â”€ Header â”€â”€ */
header {
  background: var(--white);
  border-bottom: 1px solid var(--border);
  padding: 0 2rem;
  height: 56px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.logo {
  display: flex; align-items: center; gap: 0.55rem;
  font-size: 0.88rem; font-weight: 600; color: var(--text);
}
.logo-sq {
  width: 26px; height: 26px; background: var(--accent);
  border-radius: 7px; display: flex; align-items: center;
  justify-content: center; font-size: 0.8rem;
}
.badge-internal {
  font-size: 0.65rem; font-weight: 600; letter-spacing: 0.06em;
  text-transform: uppercase; color: var(--accent);
  background: #FDEEE6; padding: 0.22rem 0.65rem;
  border-radius: 99px;
}

/* â”€â”€ Main â”€â”€ */
main {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 3rem 1.5rem;
}

.wrap {
  width: 100%;
  max-width: 480px;
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.hero {
  margin-bottom: 1.5rem;
}
.hero h1 {
  font-family: 'DM Serif Display', serif;
  font-size: 2.1rem;
  line-height: 1.15;
  letter-spacing: -0.02em;
  margin-bottom: 0.6rem;
}
.hero h1 span { color: var(--accent); }
.hero p {
  font-size: 0.9rem;
  color: var(--muted);
  line-height: 1.65;
}

/* â”€â”€ Card â”€â”€ */
.card {
  background: var(--white);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  box-shadow: 0 1px 4px rgba(0,0,0,0.05), 0 6px 20px rgba(0,0,0,0.06);
  overflow: hidden;
}

.field {
  padding: 1.3rem 1.5rem;
  border-bottom: 1px solid var(--border);
}
.field:last-child { border-bottom: none; }

label.lbl {
  display: block;
  font-size: 0.68rem; font-weight: 600;
  letter-spacing: 0.08em; text-transform: uppercase;
  color: var(--muted); margin-bottom: 0.6rem;
}

/* Drop zone */
.dz {
  position: relative;
  border: 2px dashed var(--border);
  border-radius: 9px;
  padding: 1.5rem 1rem;
  text-align: center;
  cursor: pointer;
  background: var(--bg);
  transition: border-color 0.2s, background 0.2s;
}
.dz:hover, .dz.over {
  border-color: var(--accent);
  background: #FEF3EE;
}
.dz input {
  position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%;
}
.dz-icon {
  width: 36px; height: 36px; background: #EDE9E3; border-radius: 8px;
  display: flex; align-items: center; justify-content: center;
  font-size: 1rem; margin: 0 auto 0.55rem;
  transition: background 0.2s;
}
.dz:hover .dz-icon, .dz.over .dz-icon { background: #FDDFD0; }
.dz-title { font-size: 0.83rem; font-weight: 500; }
.dz-sub   { font-size: 0.73rem; color: var(--muted); margin-top: 0.15rem; }
.chip {
  display: none;
  margin-top: 0.7rem;
  font-size: 0.72rem; font-weight: 600;
  background: #FDEEE6; color: var(--accent);
  padding: 0.25rem 0.7rem; border-radius: 99px;
  max-width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
}

/* Date input */
input[type="date"] {
  width: 100%; padding: 0.72rem 0.9rem;
  border: 1.5px solid var(--border); border-radius: 9px;
  font-family: 'DM Sans', sans-serif; font-size: 0.92rem;
  color: var(--text); background: var(--bg); outline: none;
  transition: border-color 0.2s, box-shadow 0.2s;
  color-scheme: light;
}
input[type="date"]:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(217,95,43,0.1);
}

/* Terminal log */
.log-wrap {
  display: none;
  padding: 1rem 1.5rem;
  border-bottom: 1px solid var(--border);
}
.log-wrap.vis { display: block; }
.terminal {
  background: #18110C;
  border-radius: 8px;
  padding: 0.75rem 1rem;
  max-height: 140px;
  overflow-y: auto;
  font-size: 0.73rem;
  line-height: 1.85;
}
.tl      { color: #9C8E85; }
.tl.ok   { color: #6EE7A0; }
.tl.err  { color: #FCA5A5; }
.tl.head { color: #FDB27A; font-weight: 600; }

/* Buttons */
.btns {
  padding: 1.2rem 1.5rem;
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}
.btn {
  width: 100%; padding: 0.8rem;
  border: none; border-radius: 9px;
  font-family: 'DM Sans', sans-serif;
  font-size: 0.82rem; font-weight: 600;
  cursor: pointer;
  display: flex; align-items: center; justify-content: center; gap: 0.45rem;
  transition: opacity 0.18s, transform 0.13s;
}
.btn:hover:not(:disabled) { opacity: 0.88; transform: translateY(-1px); }
.btn:active:not(:disabled){ transform: translateY(0); }
.btn:disabled { opacity: 0.35; cursor: not-allowed; }
.btn-go { background: var(--accent); color: #fff; }
.btn-dl { background: var(--green);  color: #fff; display: none; }
.btn-dl.vis { display: flex; }

@keyframes spin { to { transform: rotate(360deg); } }
.spin {
  width: 13px; height: 13px; border-radius: 50%;
  border: 2px solid rgba(255,255,255,0.3); border-top-color: #fff;
  animation: spin 0.6s linear infinite; flex-shrink: 0;
}

/* â”€â”€ Footer â”€â”€ */
footer {
  text-align: center;
  padding: 1.2rem;
  font-size: 0.7rem;
  color: var(--muted);
  border-top: 1px solid var(--border);
  background: var(--white);
}

@media (max-width: 520px) {
  .hero h1 { font-size: 1.75rem; }
  main { padding: 2rem 1rem; }
}
</style>
</head>
<body>
<main>
  <div class="wrap">

    <div class="hero">
      <h1><span>Brinteva Worlds</span></h1>
      <h1>Agregar <span>fechas</span> al itinerario</h1>
      <p>Sube el PDF del itinerario, selecciona la fecha de check-in y descarga el mismo PDF con las fechas aÃ±adidas en cada dÃ­a.</p>
    </div>

    <div class="card">

      <!-- Upload -->
      <div class="field">
        <label class="lbl">Archivo PDF</label>
        <div class="dz" id="dz">
          <input type="file" accept=".pdf" id="fileIn"/>
          <div class="dz-icon">ðŸ“„</div>
          <div class="dz-title">Arrastra tu PDF aquÃ­</div>
          <div class="dz-sub">o haz clic para seleccionar el archivo</div>
          <div class="chip" id="chip"></div>
        </div>
      </div>

      <!-- Date -->
      <div class="field">
        <label class="lbl" for="dt">Fecha de llegada â€” DÃ­a 1</label>
        <input type="date" id="dt"/>
      </div>

      <!-- Log -->
      <div class="log-wrap" id="logWrap">
        <div class="terminal" id="term"></div>
      </div>

      <!-- Buttons -->
      <div class="btns">
        <button class="btn btn-go" id="goBtn" disabled onclick="run()">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
            <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
          </svg>
          Detectar dÃ­as y agregar fechas
        </button>
        <button class="btn btn-dl" id="dlBtn">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
            <polyline points="7 10 12 15 17 10"/>
            <line x1="12" y1="15" x2="12" y2="3"/>
          </svg>
          Descargar PDF con fechas
        </button>
      </div>

    </div>
  </div>
</main>

<footer>
  Brinteva Worlds Inc Â· 130 E Leland Rd, Pittsburg &nbsp;Â·&nbsp; 
</footer>

<script>
pdfjsLib.GlobalWorkerOptions.workerSrc =
  'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

const MES = ["enero","febrero","marzo","abril","mayo","junio",
             "julio","agosto","septiembre","octubre","noviembre","diciembre"];
const fmt    = d => `${d.getDate()} de ${MES[d.getMonth()]} de ${d.getFullYear()}`;
const sumDay = (s, n) => { const [y,m,d]=s.split('-').map(Number); return new Date(y,m-1,d+n); };

let file=null, bytes=null;

const fileIn  = document.getElementById('fileIn');
const dt      = document.getElementById('dt');
const goBtn   = document.getElementById('goBtn');
const dlBtn   = document.getElementById('dlBtn');
const logWrap = document.getElementById('logWrap');
const term    = document.getElementById('term');
const chip    = document.getElementById('chip');
const dz      = document.getElementById('dz');

function sync(){
  goBtn.disabled = !(file && dt.value);
  dlBtn.classList.remove('vis');
  bytes = null;
}

fileIn.addEventListener('change', e => {
  file = e.target.files[0] || null;
  if(file){ chip.textContent='âœ“ '+file.name; chip.style.display='inline-block'; }
  sync();
});
dt.addEventListener('change', sync);

dz.addEventListener('dragover',  e => { e.preventDefault(); dz.classList.add('over'); });
dz.addEventListener('dragleave', () => dz.classList.remove('over'));
dz.addEventListener('drop', e => {
  e.preventDefault(); dz.classList.remove('over');
  const f = e.dataTransfer.files[0];
  if(f?.type==='application/pdf'){
    file=f;
    chip.textContent='âœ“ '+f.name; chip.style.display='inline-block';
    sync();
  }
});

function clearLog(){ term.innerHTML=''; logWrap.classList.remove('vis'); }
function log(msg, cls=''){
  logWrap.classList.add('vis');
  const el = document.createElement('div');
  el.className = 'tl ' + cls;
  el.textContent = msg;
  term.appendChild(el);
  term.scrollTop = term.scrollHeight;
}

async function run(){
  clearLog(); bytes=null;
  dlBtn.classList.remove('vis');
  goBtn.disabled = true;
  goBtn.innerHTML = '<div class="spin"></div> Procesando...';

  try {
    const buf = await file.arrayBuffer();

    // â”€â”€ 1. Detectar encabezados con pdfjs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    log('Escaneando encabezados de dÃ­as...', 'head');
    const pdfJs = await pdfjsLib.getDocument({data: buf.slice(0)}).promise;
    const REG   = /DÃ­a\s+(\d+)\s*[:\-â€“]/;
    const found = {};

    for(let p=1; p<=pdfJs.numPages; p++){
      const pg = await pdfJs.getPage(p);
      const vp = pg.getViewport({scale:1});
      const tc = await pg.getTextContent();

      const lines = {};
      for(const it of tc.items){
        if(!it.str?.trim()) continue;
        const yTop = vp.height - it.transform[5];
        const key  = Math.round(yTop/2)*2;
        if(!lines[key]) lines[key]={items:[], yTop, x:it.transform[4]};
        lines[key].items.push(it.str);
      }

      for(const ld of Object.values(lines)){
        const txt = ld.items.join(' ');
        const m   = REG.exec(txt);
        if(m){
          const n = parseInt(m[1]);
          if(!found[n]){
            found[n] = {pageIdx:p-1, x:ld.x, yTop:ld.yTop, pgH:vp.height};
            log(`  âœ“ DÃ­a ${n} â€” pÃ¡gina ${p}`, 'ok');
          }
        }
      }
    }

    const total = Object.keys(found).length;
    if(!total){
      log('No se encontraron encabezados "DÃ­a X". Verifica que sea un itinerario de Mundi Travels.', 'err');
      return;
    }
    log(`\nEncontrados ${total} dÃ­a(s). Agregando fechas...`, 'head');

    // â”€â”€ 2. Superponer fechas con pdf-lib â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const {PDFDocument, rgb, StandardFonts} = PDFLib;
    const doc  = await PDFDocument.load(buf);
    const font = await doc.embedFont(StandardFonts.HelveticaBold);
    const pgs  = doc.getPages();

    for(const [ns, pos] of Object.entries(found)){
      const n     = parseInt(ns);
      const dStr  = fmt(sumDay(dt.value, n-1));
      const pg    = pgs[pos.pageIdx];
      const {height} = pg.getSize();

      // Place ~15pt ABOVE the heading â€” plain black text, no background
      const ry = height - pos.yTop + 15;

      pg.drawText(dStr, {
        x: pos.x,
        y: ry,
        size: 8,
        font,
        color: rgb(0, 0, 0),
      });

      log(`  DÃ­a ${n} â†’ ${dStr}`, 'ok');
    }

    bytes = await doc.save();
    log('\nListo. Haz clic en el botÃ³n para descargar.', 'ok');
    dlBtn.classList.add('vis');
    dlBtn.onclick = download;

  } catch(e){
    log('Error: ' + e.message, 'err');
    console.error(e);
  } finally {
    goBtn.disabled = !(file && dt.value);
    goBtn.innerHTML = `<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
      <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
    </svg> Detectar dÃ­as y agregar fechas`;
  }
}

function download(){
  if(!bytes) return;
  try {
    const blob = new Blob([bytes], {type:'application/pdf'});
    const url  = URL.createObjectURL(blob);
    const a    = document.createElement('a');
    a.href     = url;
    a.download = file.name.replace(/\.pdf$/i, '') + '-con-fechas.pdf';
    a.style.display = 'none';
    document.body.appendChild(a);
    a.click();
    setTimeout(() => { document.body.removeChild(a); URL.revokeObjectURL(url); }, 1500);
  } catch(e){
    alert('Error al descargar: ' + e.message);
  }
}
</script>
</body>
</html>
